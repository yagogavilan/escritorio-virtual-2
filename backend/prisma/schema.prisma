generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  master
  admin
  user
  visitor
}

enum UserStatus {
  online
  busy
  away
  offline
  in_meeting
}

enum RoomType {
  fixed
}

enum TaskStatus {
  todo
  in_progress
  review
  done
}

enum TaskPriority {
  low
  medium
  high
}

enum ChannelType {
  dm
  group
}

enum PaymentStatus {
  pending
  confirmed
  overdue
}

model User {
  id              String     @id @default(uuid())
  email           String     @unique
  password        String     @default("")
  name            String
  avatar          String     @default("")
  role            UserRole   @default(user)
  status          UserStatus @default(offline)
  statusMessage   String?
  jobTitle        String?

  officeId        String?
  office          Office?    @relation(fields: [officeId], references: [id])

  sectorId        String?
  sector          Sector?    @relation(fields: [sectorId], references: [id])

  currentRoomId   String?
  currentRoom     Room?      @relation("RoomParticipants", fields: [currentRoomId], references: [id])

  visitorInviteId String?    @unique
  visitorInvite   VisitorInvite? @relation("VisitorUser", fields: [visitorInviteId], references: [id])

  // Relations
  createdInvites  VisitorInvite[] @relation("InviteCreator")
  ownedRooms      Room[]          @relation("RoomOwner")
  channels        ChannelMember[]
  sentMessages    ChatMessage[]
  createdTasks    Task[]          @relation("TaskCreator")
  assignedTasks   Task[]          @relation("TaskAssignee")
  taskComments    TaskComment[]
  announcements   Announcement[]
  announcementReads AnnouncementRead[]
  messageReads    MessageRead[]

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model Office {
  id            String   @id @default(uuid())
  name          String
  logo          String   @default("")
  primaryColor  String   @default("#3b82f6")

  workingHoursEnabled Boolean @default(false)
  workingHoursStart   String  @default("08:00")
  workingHoursEnd     String  @default("18:00")

  users         User[]
  sectors       Sector[]
  rooms         Room[]
  billingPlan   BillingPlan?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Sector {
  id        String   @id @default(uuid())
  name      String
  color     String   @default("#3b82f6")

  officeId  String?
  office    Office?  @relation(fields: [officeId], references: [id])

  users     User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Room {
  id              String   @id @default(uuid())
  name            String
  type            RoomType @default(fixed)
  capacity        Int      @default(10)
  isRestricted    Boolean  @default(false)
  color           String?
  backgroundImage String?
  icon            String?

  officeId        String?
  office          Office?  @relation(fields: [officeId], references: [id])

  ownerId         String?
  owner           User?    @relation("RoomOwner", fields: [ownerId], references: [id])

  participants    User[]   @relation("RoomParticipants")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model VisitorInvite {
  id                String    @id @default(uuid())
  code              String    @unique
  expiresAt         DateTime
  durationInMinutes Int       @default(60)

  creatorId         String
  creator           User      @relation("InviteCreator", fields: [creatorId], references: [id])

  usedBy            User?     @relation("VisitorUser")

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model ChatChannel {
  id          String        @id @default(uuid())
  type        ChannelType   @default(dm)
  name        String?

  members     ChannelMember[]
  messages    ChatMessage[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model ChannelMember {
  id          String      @id @default(uuid())

  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  channelId   String
  channel     ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  joinedAt    DateTime    @default(now())

  @@unique([userId, channelId])
}

model ChatMessage {
  id          String        @id @default(uuid())
  text        String
  mentions    String[]      @default([])

  senderId    String
  sender      User          @relation(fields: [senderId], references: [id])

  channelId   String
  channel     ChatChannel   @relation(fields: [channelId], references: [id], onDelete: Cascade)

  readBy      MessageRead[]

  editedAt    DateTime?
  createdAt   DateTime      @default(now())
}

model MessageRead {
  id          String      @id @default(uuid())

  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  messageId   String
  message     ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  readAt      DateTime    @default(now())

  @@unique([userId, messageId])
}

model Task {
  id          String       @id @default(uuid())
  title       String
  description String       @default("")
  status      TaskStatus   @default(todo)
  priority    TaskPriority @default(medium)
  dueDate     DateTime?
  tags        String[]     @default([])

  creatorId   String
  creator     User         @relation("TaskCreator", fields: [creatorId], references: [id])

  assigneeId  String
  assignee    User         @relation("TaskAssignee", fields: [assigneeId], references: [id])

  comments    TaskComment[]
  history     TaskHistory[]
  attachments TaskAttachment[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model TaskComment {
  id        String   @id @default(uuid())
  text      String
  mentions  String[] @default([])

  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId    String
  user      User     @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

model TaskHistory {
  id        String   @id @default(uuid())
  action    String

  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  userId    String

  createdAt DateTime @default(now())
}

model TaskAttachment {
  id        String   @id @default(uuid())
  name      String
  url       String
  type      String
  size      Int

  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model Announcement {
  id           String   @id @default(uuid())
  title        String
  message      String
  imageUrl     String?
  soundUrl     String?
  scheduledFor DateTime?
  recipients   String[] @default([])

  senderId     String
  sender       User     @relation(fields: [senderId], references: [id])

  readBy       AnnouncementRead[]

  createdAt    DateTime @default(now())
}

model AnnouncementRead {
  id             String       @id @default(uuid())

  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)

  readAt         DateTime     @default(now())

  @@unique([userId, announcementId])
}

model BillingPlan {
  id              String   @id @default(uuid())
  officeId        String   @unique
  office          Office   @relation(fields: [officeId], references: [id], onDelete: Cascade)

  pricePerUser    Decimal  @default(0)
  customNotes     String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  payments        Payment[]
}

model Payment {
  id              String        @id @default(uuid())
  billingPlanId   String
  billingPlan     BillingPlan   @relation(fields: [billingPlanId], references: [id], onDelete: Cascade)

  month           Int
  year            Int
  amount          Decimal
  userCount       Int
  status          PaymentStatus @default(pending)

  confirmedAt     DateTime?
  confirmedBy     String?
  notes           String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([billingPlanId, month, year])
}

model ActivityLog {
  id              String   @id @default(uuid())
  userId          String
  officeId        String?

  action          String
  metadata        Json?

  createdAt       DateTime @default(now())

  @@index([userId, createdAt])
  @@index([officeId, createdAt])
}
